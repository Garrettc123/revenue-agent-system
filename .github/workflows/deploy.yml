name: Deploy Revenue System

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run health check
        run: |
          python -c "from app import app; print('âœ… App imports successfully')"
      
      - name: Test Flask endpoints
        run: |
          python -c "
          from app import app
          with app.test_client() as client:
              # Test health endpoint
              response = client.get('/health')
              assert response.status_code == 200
              assert response.json['status'] == 'healthy'
              
              # Test revenue API
              response = client.get('/api/revenue')
              assert response.status_code == 200
              assert 'mrr' in response.json
              
              # Test dashboard
              response = client.get('/')
              assert response.status_code == 200
              
          print('âœ… All tests passed!')
          "
  
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t revenue-agent:${{ github.sha }} .
          docker build -t revenue-agent:latest .
      
      - name: Test Docker image
        run: |
          docker run -d -p 8000:8000 --name test-revenue revenue-agent:latest
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:8000/health || exit 1
          
          docker stop test-revenue
          docker rm test-revenue
          
          echo "âœ… Docker image works correctly"
  
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Render
        if: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
          echo "âœ… Deployment triggered on Render"
      
      - name: Deploy to Railway
        if: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          npm install -g @railway/cli
          railway up --service revenue-agent
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Deployment Summary
        run: |
          echo "ðŸš€ Deployment initiated!"
          echo "Check your deployment platform for status."
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"
